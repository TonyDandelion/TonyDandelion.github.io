

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=&#34;dark&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" type="image/png" href="/img/favicon.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="知无涯者">
  <meta name="keywords" content="">
  <title>Mybatis基本原理 - 代码即艺术</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10.4.0/styles/monokai.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />
  



<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.8.7","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"onlypost":false},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null}}};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.3.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>代码即艺术</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/introduction/">
                <i class="iconfont icon-map"></i>
                入门
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/404page.html">
                <i class="iconfont icon-heartbeat"></i>
                公益404
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" href="javascript:">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="Mybatis基本原理">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2020-08-26 11:09" pubdate>
        2020年8月26日 上午
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      7.3k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      112
       分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">Mybatis基本原理</h1>
            
            <div class="markdown-body">
              <p>简述Mybatis基本原理</p>
<a id="more"></a>
<h1 id="Mybatis快速开始"><a href="#Mybatis快速开始" class="headerlink" title="Mybatis快速开始"></a>Mybatis快速开始</h1><p>1、引入pom依赖</p>
<p>2、Mybatis配置文件</p>
<p>3、编写映射文件</p>
<p>4、编写代码调用 <code>SqlSession</code> 执行sql语句</p>
<p>5、关闭<code>SqlSession</code></p>
<h1 id="Spring-boot是如何加载Mybatis的？"><a href="#Spring-boot是如何加载Mybatis的？" class="headerlink" title="Spring-boot是如何加载Mybatis的？"></a>Spring-boot是如何加载Mybatis的？</h1><p>熟悉 SpringBoot 启动过程的朋友知道，SpringBoot 会去加载mybatis-spring-boot-autoconfigure-x.x.x.jar下 META-INF 中的spring.factories文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs factories"># Auto Configure<br>org.springframework.boot.autoconfigure.EnableAutoConfiguration&#x3D;\<br>org.mybatis.spring.boot.autoconfigure.MybatisLanguageDriverAutoConfiguration,\<br>org.mybatis.spring.boot.autoconfigure.MybatisAutoConfiguration<br></code></pre></div></td></tr></table></figure>
<p><code>MybatisAutoConfiguration()</code></p>
<figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MybatisAutoConfiguration</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">InitializingBean</span> </span>&#123;<br>	<span class="hljs-comment">//...</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-meta">@ConditionalOnMissingBean</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> SqlSessionFactory <span class="hljs-title">sqlSessionFactory</span><span class="hljs-params">(DataSource dataSource)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>    	<span class="hljs-comment">// ...</span><br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>可以发现，<code>SqlSessionFactory</code> 方法是我们的入口处。也就是说 Spring-boot 是通过 启动 <code>SqlSessionFactory</code> 加载了Mybatis框架。</p>
<h1 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h1><p>本博文使用 Mybatis 3.5.5 版本。</p>
<p><em>创建 database table</em></p>
<figure class="highlight sql"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs sql"> <span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> user_info(<br>    <span class="hljs-operator">-</span><span class="hljs-operator">&gt;</span> id <span class="hljs-type">int</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">null</span> <span class="hljs-keyword">primary</span> key AUTO_INCREMENT,<br>    <span class="hljs-operator">-</span><span class="hljs-operator">&gt;</span> name <span class="hljs-type">char</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">not</span> <span class="hljs-keyword">null</span>,<br>    <span class="hljs-operator">-</span><span class="hljs-operator">&gt;</span> age <span class="hljs-type">char</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">not</span> <span class="hljs-keyword">null</span><br>    <span class="hljs-operator">-</span><span class="hljs-operator">&gt;</span> );<br><span class="hljs-keyword">desc</span> user_info;<br><span class="hljs-operator">+</span><span class="hljs-comment">-------+----------+------+-----+---------+----------------+</span><br><span class="hljs-operator">|</span> Field <span class="hljs-operator">|</span> Type     <span class="hljs-operator">|</span> <span class="hljs-keyword">Null</span> <span class="hljs-operator">|</span> Key <span class="hljs-operator">|</span> <span class="hljs-keyword">Default</span> <span class="hljs-operator">|</span> Extra               <span class="hljs-operator">|</span> <br><span class="hljs-operator">+</span><span class="hljs-comment">-------+----------+------+-----+---------+----------------+</span><br><span class="hljs-operator">|</span> id    <span class="hljs-operator">|</span> <span class="hljs-type">int</span>      <span class="hljs-operator">|</span> <span class="hljs-keyword">NO</span>   <span class="hljs-operator">|</span> PRI <span class="hljs-operator">|</span> <span class="hljs-keyword">NULL</span>    <span class="hljs-operator">|</span> auto_increment <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span> name  <span class="hljs-operator">|</span> <span class="hljs-type">char</span>(<span class="hljs-number">50</span>) <span class="hljs-operator">|</span> <span class="hljs-keyword">NO</span>   <span class="hljs-operator">|</span>     <span class="hljs-operator">|</span> <span class="hljs-keyword">NULL</span>    <span class="hljs-operator">|</span>                       <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span> age   <span class="hljs-operator">|</span> <span class="hljs-type">char</span>(<span class="hljs-number">50</span>) <span class="hljs-operator">|</span> <span class="hljs-keyword">NO</span>   <span class="hljs-operator">|</span>     <span class="hljs-operator">|</span> <span class="hljs-keyword">NULL</span>    <span class="hljs-operator">|</span>                         <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">-------+----------+------+-----+---------+----------------+</span><br></code></pre></div></td></tr></table></figure>
<p>User Object</p>
<figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> Long id;<br>    <span class="hljs-keyword">private</span> String name;<br>    <span class="hljs-keyword">private</span> Integer age;<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>mapper:UserMapper 为根据id查询用户信息</p>
<figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">UserMapper</span> </span>&#123;<br>    <span class="hljs-function">User <span class="hljs-title">selectUserById</span><span class="hljs-params">(Integer id)</span></span>;<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>UserMapper.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">mapper</span></span><br><span class="hljs-meta">        <span class="hljs-meta-keyword">PUBLIC</span> <span class="hljs-meta-string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span></span><br><span class="hljs-meta">        <span class="hljs-meta-string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">namespace</span>=<span class="hljs-string">&quot;com.wsdsg.spring.boot.analyze.mapper.UserMapper&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;selectUserById&quot;</span> <span class="hljs-attr">resultType</span>=<span class="hljs-string">&quot;com.wsdsg.spring.boot.analyze.entity.User&quot;</span></span><br><span class="hljs-tag">            <span class="hljs-attr">parameterType</span>=<span class="hljs-string">&quot;java.lang.Integer&quot;</span>&gt;</span><br>        select * from user_info where id = #&#123;id&#125;<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">mapper</span>&gt;</span><br></code></pre></div></td></tr></table></figure>
<p>mybaitis的主配置文件 <code>mybatis-config.xml</code> ：</p>
<figure class="highlight xml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">configuration</span></span><br><span class="hljs-meta">        <span class="hljs-meta-keyword">PUBLIC</span> <span class="hljs-meta-string">&quot;-//mybatis.org//DTD Config 3.0//EN&quot;</span></span><br><span class="hljs-meta">        <span class="hljs-meta-string">&quot;http://mybatis.org/dtd/mybatis-3-config.dtd&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">properties</span> <span class="hljs-attr">resource</span>=<span class="hljs-string">&quot;dbconfig.properties&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">environments</span> <span class="hljs-attr">default</span>=<span class="hljs-string">&quot;development&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">environment</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;development&quot;</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">transactionManager</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;JDBC&quot;</span>/&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">dataSource</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;POOLED&quot;</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;driver&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;$&#123;jdbc.driver&#125;&quot;</span>/&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;url&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;$&#123;jdbc.url&#125;&quot;</span>/&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;username&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;$&#123;jdbc.username&#125;&quot;</span>/&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;password&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;$&#123;jdbc.password&#125;&quot;</span>/&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">dataSource</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">environment</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">environments</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">mappers</span>&gt;</span><br>        <span class="hljs-comment">&lt;!--resource--&gt;</span><br>         <span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">resource</span>=<span class="hljs-string">&quot;UserMapper.xml&quot;</span>/&gt;</span><br><br>        <span class="hljs-comment">&lt;!--class--&gt;</span><br>        <span class="hljs-comment">&lt;!-- &lt;mapper class=&quot;com.wsdsg.spring.boot.analyze.mapper.UserMapper&quot;/&gt;--&gt;</span><br>        <span class="hljs-comment">&lt;!--url--&gt;</span><br>        <span class="hljs-comment">&lt;!--&lt;mapper url=&quot;D:\coder_soft\idea_workspace\ecard_bus\spring-boot-analyze\target\classes\UserMapper.xml&quot;/&gt;--&gt;</span><br>        <span class="hljs-comment">&lt;!--package--&gt;</span><br>        <span class="hljs-comment">&lt;!--&lt;package name=&quot;com.wsdsg.spring.boot.analyze.mapper&quot; /&gt;--&gt;</span><br>      <br>    <span class="hljs-tag">&lt;/<span class="hljs-name">mappers</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span><br></code></pre></div></td></tr></table></figure>
<p>数据库连接的属性文件 *.property：</p>
<figure class="highlight ini"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs ini"><span class="hljs-attr">jdbc.driver</span>=com.mysql.cj.jdbc.Driver<br><span class="hljs-attr">jdbc.url</span>=jdbc:mysql://localhost:<span class="hljs-number">3306</span>/mysql?useUnicode=<span class="hljs-literal">true</span>&amp;useJDBCCompliantTimezoneShift=<span class="hljs-literal">true</span>&amp;useLegacyDatetimeCode=<span class="hljs-literal">false</span>&amp;serverTimezone=UTC<br><span class="hljs-attr">jdbc.username</span>=root<br><span class="hljs-attr">jdbc.password</span>=<span class="hljs-number">123456</span><br></code></pre></div></td></tr></table></figure>
<p>测试类</p>
<figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestMybatis</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">CommandLineRunner</span></span>&#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">(String... args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        String resource = <span class="hljs-string">&quot;mybatis-config.xml&quot;</span>;<br>        InputStream inputStream = Resources.getResourceAsStream(resource);<br>        SqlSessionFactory sqlSessionFactory = <span class="hljs-keyword">new</span> SqlSessionFactoryBuilder().build(inputStream);<br>        SqlSession session = sqlSessionFactory.openSession();<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">/*UserMapper mapper = session.getMapper(UserMapper.class);</span><br><span class="hljs-comment">            User user = mapper.selectUserById(1);</span><br><span class="hljs-comment">            System.out.println(user);*/</span><br>            Object o = session.selectOne(<span class="hljs-string">&quot;com.wsdsg.spring.boot.analyze.mapper.UserMapper.selectUserById&quot;</span>, <span class="hljs-number">1</span>);<br>            System.out.println(<span class="hljs-string">&quot;我是第一次查询的&quot;</span>+o);<br>            System.out.println(<span class="hljs-string">&quot;-------------------------------我是分割线---------------------&quot;</span>);<br>            Object z = session.selectOne(<span class="hljs-string">&quot;com.wsdsg.spring.boot.analyze.mapper.UserMapper.selectUserById&quot;</span>, <span class="hljs-number">1</span>);<br>            System.out.println(<span class="hljs-string">&quot;我是第二次查询的&quot;</span>+z);<br>           <span class="hljs-comment">/*User user = new User();</span><br><span class="hljs-comment">           user.setAge(15);</span><br><span class="hljs-comment">           user.setName(&quot;achuan&quot;);</span><br><span class="hljs-comment">           int insert = session.insert(&quot;com.wsdsg.spring.boot.analyze.mapper.UserMapper.addOneUser&quot;, user);</span><br><span class="hljs-comment">           session.commit();</span><br><span class="hljs-comment">           System.out.println(insert);*/</span><br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            session.close();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>
<h1 id="MyBatis重要组件和运行流程图"><a href="#MyBatis重要组件和运行流程图" class="headerlink" title="MyBatis重要组件和运行流程图"></a>MyBatis重要组件和运行流程图</h1><ul>
<li><code>Configuration</code> MyBatis所有的配置信息都保存在Configuration对象之中，配置文件中的大部分配置都会存储到该类中</li>
<li><code>SqlSession</code> 作为MyBatis工作的主要顶层API，表示和数据库交互时的会话，完成必要数据库增删改查功能</li>
<li><code>Executor</code> MyBatis执行器，是MyBatis 调度的核心，负责SQL语句的生成和查询缓存的维护</li>
<li><code>StatementHandler</code> 封装了JDBC Statement操作，负责对JDBC statement 的操作，如设置参数等</li>
<li><code>ParameterHandler</code> 负责对用户传递的参数转换成JDBC Statement 所对应的数据类型</li>
<li><code>ResultSetHandler</code> 负责将JDBC返回的ResultSet结果集对象转换成List类型的集合</li>
<li><code>TypeHandler</code> 负责java数据类型和jdbc数据类型(也可以说是数据表列类型)之间的映射和转换</li>
<li><code>MappedStatement</code> MappedStatement维护一条<select|update|delete|insert>节点的封装</li>
<li><code>SqlSource</code> 负责根据用户传递的parameterObject，动态地生成SQL语句，将信息封装到BoundSql对象中，并返回。</li>
<li><code>BoundSql</code> 表示动态生成的SQL语句以及相应的参数信息</li>
</ul>
<pre><code class=" mermaid">graph TB
	SqlSession[SqlSession: Mybatis顶层API 通过会话访问提供crud能力] --&gt; Executor
	Executor[Executor: Mybatis的执行核心 负责SQL语言的生产执行和缓存维护] --&gt; StatementHandler
	StatementHandler[StatementHandler: 负责JDBC的Statement交互 包括设置statement参数和将JDBC返回结果转换为List] --&gt; ParameterHandler
	StatementHandler --&gt; ResultSetHandler
	ParameterHandler[ParameterHandler: 设置Statement参数] --&gt; TypeHandler
	ResultSetHandler[ResultSetHandler: 将JDBC返回结果转换为List] --&gt; TypeHandler
	TypeHandler[TypeHandler: 负责JDBC Type和Java Type之间的转换 &#x2F; 设置参数 &#x2F; 取出查询结果中的特定列] --&gt; Stratement
	Stratement[JDBC Stratement: PreparedStatement &#x2F; SimpleStatement &#x2F; CallableStatement]
	Stratement --&gt; ResultSet[ResultSet: 查询结果继]
	ResultSet --&gt; TypeHandler
</code></pre>
<p>流程图</p>
<pre><code class=" mermaid">graph LR
	mybatis --&gt; Build
	Build --&gt; xml[XML File] --&gt; sqlSessionFactory
	Build --&gt; Java[Java Code] --&gt; sqlSessionFactory
	sqlSessionFactory --&gt; SqlSession
	SqlSession --调用XML文件中定义的SQL语句--&gt; SqlSession.getMapper
    SqlSession --调用Java Code中定义的SQL语句--&gt; SqlSession.getMapper
</code></pre>
<h1 id="Mybatis基本机制"><a href="#Mybatis基本机制" class="headerlink" title="Mybatis基本机制"></a>Mybatis基本机制</h1><h2 id="0-配置加载"><a href="#0-配置加载" class="headerlink" title="0 配置加载"></a>0 配置加载</h2><p>获取mybatis主配置文件的输入流对象。</p>
<figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java">String resource = <span class="hljs-string">&quot;mybatis-config.xml&quot;</span>;<br> InputStream inputStream = Resources.getResourceAsStream(resource);<br></code></pre></div></td></tr></table></figure>
<h2 id="1-解析mapper文件"><a href="#1-解析mapper文件" class="headerlink" title="1 解析mapper文件"></a>1 解析mapper文件</h2><p>入口代码</p>
<figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java">SqlSessionFactory sqlSessionFactory = <span class="hljs-keyword">new</span> SqlSessionFactoryBuilder().build(inputStream);<br></code></pre></div></td></tr></table></figure>
<h3 id="1-1-解析主配置文件-parser-parse"><a href="#1-1-解析主配置文件-parser-parse" class="headerlink" title="1.1 解析主配置文件 parser.parse()"></a>1.1 解析主配置文件 <code>parser.parse()</code></h3><p><code>SqlSessionFactoryBuilder().build()</code></p>
<p>会创建一个XMLConfigBuilder对象，这个对象的作用就是<strong>解析主配置文件</strong>。</p>
<p>可以看出主配置文件 <code>mybatis-config.xml</code> 的最外层节点是 <code>&lt;configuration&gt;</code> 标签，mybatis的初始化就是把这个标签以及他的所有子标签进行解析，把解析好的数据封装在 <code>Configuration</code> 这个类中。</p>
<figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java">XMLConfigBuilder parser = <span class="hljs-keyword">new</span> XMLConfigBuilder(inputStream, environment, properties);<br></code></pre></div></td></tr></table></figure>
<p>调用 <code>parser.parse()</code> 进行解析</p>
<figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java">var5 = <span class="hljs-keyword">this</span>.build(parser.parse());<br></code></pre></div></td></tr></table></figure>
<p><code>parser.parse()</code> 内容，<code>XMLConfigBuilder</code> 维护一个parsed属性默认为false，这个方法一开始就判断这个主配置文件是否已经被解析，如果解析过了就抛异常。由于这里是工厂模式，所以每次只会解析一次主配置文件。后面即使创建新的链接，也无需再次解析主配置文件。</p>
<figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> Configuration <span class="hljs-title">parse</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.parsed) &#123;<br>    	<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BuilderException(<span class="hljs-string">&quot;Each XMLConfigBuilder can only be used once.&quot;</span>);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">this</span>.parsed = <span class="hljs-keyword">true</span>;<br>        <span class="hljs-keyword">this</span>.parseConfiguration(<span class="hljs-keyword">this</span>.parser.evalNode(<span class="hljs-string">&quot;/configuration&quot;</span>));<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.configuration;<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p><code>this.parseConfiguration()</code></p>
<figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">parseConfiguration</span><span class="hljs-params">(XNode root)</span> </span>&#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-keyword">this</span>.propertiesElement(root.evalNode(<span class="hljs-string">&quot;properties&quot;</span>));<br>        Properties settings = <span class="hljs-keyword">this</span>.settingsAsProperties(root.evalNode(<span class="hljs-string">&quot;settings&quot;</span>));<br>        <span class="hljs-keyword">this</span>.loadCustomVfs(settings);<br>        <span class="hljs-keyword">this</span>.loadCustomLogImpl(settings);<br>        <span class="hljs-keyword">this</span>.typeAliasesElement(root.evalNode(<span class="hljs-string">&quot;typeAliases&quot;</span>));<br>        <span class="hljs-keyword">this</span>.pluginElement(root.evalNode(<span class="hljs-string">&quot;plugins&quot;</span>));<br>        <span class="hljs-keyword">this</span>.objectFactoryElement(root.evalNode(<span class="hljs-string">&quot;objectFactory&quot;</span>));<br>        <span class="hljs-keyword">this</span>.objectWrapperFactoryElement(root.evalNode(<span class="hljs-string">&quot;objectWrapperFactory&quot;</span>));<br>        <span class="hljs-keyword">this</span>.reflectorFactoryElement(root.evalNode(<span class="hljs-string">&quot;reflectorFactory&quot;</span>));<br>        <span class="hljs-keyword">this</span>.settingsElement(settings);<br>        <span class="hljs-keyword">this</span>.environmentsElement(root.evalNode(<span class="hljs-string">&quot;environments&quot;</span>));<br>        <span class="hljs-keyword">this</span>.databaseIdProviderElement(root.evalNode(<span class="hljs-string">&quot;databaseIdProvider&quot;</span>));<br>        <span class="hljs-keyword">this</span>.typeHandlerElement(root.evalNode(<span class="hljs-string">&quot;typeHandlers&quot;</span>));<br>        <span class="hljs-keyword">this</span>.mapperElement(root.evalNode(<span class="hljs-string">&quot;mappers&quot;</span>));<br>    &#125; <span class="hljs-keyword">catch</span> (Exception var3) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BuilderException(<span class="hljs-string">&quot;Error parsing SQL Mapper Configuration. Cause: &quot;</span> + var3, var3);<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>可以看出这个方法是对 <code>&lt;configuration&gt;</code> 的所有子标签挨个解析。</p>
<ul>
<li>settings属性配置，在settings会配置缓存，日志之类的。</li>
<li>typeAliases是配置别名。</li>
<li>environments是配置数据库链接和事务。</li>
</ul>
<p>这些子节点会被一个个解析并且把解析后的数据封装在 <code>Configuration</code> 这个类中，可以看到<code>parser.parse()</code> 方法返回的就是由 <code>mybatis-config.xml</code> 文件解析出来的 <code>Configuration</code> 对象。</p>
<blockquote>
<p>总结：解析主配置文件把主配置文件里的所有信息封装到Configuration这个对象中</p>
</blockquote>
<h3 id="1-2-mappers解析-mapperElement"><a href="#1-2-mappers解析-mapperElement" class="headerlink" title="1.2 mappers解析 mapperElement()"></a>1.2 mappers解析 <code>mapperElement()</code></h3><p>在这里我们重点分析的解析mappers这个子标签，这个标签里面还会有一个个的mapper标签去映射mapper所对应的mapper.xml，比如这次配置的 <code>UserMapper.xml</code>。</p>
<figure class="highlight xml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">configuration</span></span><br><span class="hljs-meta">        <span class="hljs-meta-keyword">PUBLIC</span> <span class="hljs-meta-string">&quot;-//mybatis.org//DTD Config 3.0//EN&quot;</span></span><br><span class="hljs-meta">        <span class="hljs-meta-string">&quot;http://mybatis.org/dtd/mybatis-3-config.dtd&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span><br>  	<span class="hljs-comment">&lt;!-- </span><br><span class="hljs-comment">        properties/environments 配置 </span><br><span class="hljs-comment">        ...</span><br><span class="hljs-comment">	--&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">mappers</span>&gt;</span><br>        <span class="hljs-comment">&lt;!--resource--&gt;</span><br>         <span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">resource</span>=<span class="hljs-string">&quot;UserMapper.xml&quot;</span>/&gt;</span><br><br>        <span class="hljs-comment">&lt;!--class--&gt;</span><br>        <span class="hljs-comment">&lt;!-- &lt;mapper class=&quot;com.wsdsg.spring.boot.analyze.mapper.UserMapper&quot;/&gt;--&gt;</span><br>      <br>        <span class="hljs-comment">&lt;!--url--&gt;</span><br>        <span class="hljs-comment">&lt;!--&lt;mapper url=&quot;D:\coder_soft\idea_workspace\ecard_bus\spring-boot-analyze\target\classes\UserMapper.xml&quot;/&gt;--&gt;</span><br>      <br>        <span class="hljs-comment">&lt;!--package--&gt;</span><br>        <span class="hljs-comment">&lt;!--&lt;package name=&quot;com.wsdsg.spring.boot.analyze.mapper&quot; /&gt;--&gt;</span><br>      <br>    <span class="hljs-tag">&lt;/<span class="hljs-name">mappers</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span><br></code></pre></div></td></tr></table></figure>
<p><code>this.mapperElement</code> 源码如下</p>
<figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">mapperElement</span><span class="hljs-params">(XNode parent)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        <span class="hljs-keyword">if</span> (parent != <span class="hljs-keyword">null</span>) &#123;<br>            Iterator var2 = parent.getChildren().iterator();<br><br>            <span class="hljs-keyword">while</span>(<span class="hljs-keyword">true</span>) &#123;<br>                <span class="hljs-keyword">while</span>(var2.hasNext()) &#123;<br>                    XNode child = (XNode)var2.next();<br>                    String resource;<br>                    <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;package&quot;</span>.equals(child.getName())) &#123;<br>                        resource = child.getStringAttribute(<span class="hljs-string">&quot;name&quot;</span>);<br>                        <span class="hljs-keyword">this</span>.configuration.addMappers(resource);<br>                    &#125; <span class="hljs-keyword">else</span> &#123;<br>                        resource = child.getStringAttribute(<span class="hljs-string">&quot;resource&quot;</span>);<br>                        String url = child.getStringAttribute(<span class="hljs-string">&quot;url&quot;</span>);<br>                        String mapperClass = child.getStringAttribute(<span class="hljs-string">&quot;class&quot;</span>);<br>                        XMLMapperBuilder mapperParser;<br>                        InputStream inputStream;<br>                        <span class="hljs-keyword">if</span> (resource != <span class="hljs-keyword">null</span> &amp;&amp; url == <span class="hljs-keyword">null</span> &amp;&amp; mapperClass == <span class="hljs-keyword">null</span>) &#123;<br>                            ErrorContext.instance().resource(resource);<br>                            inputStream = Resources.getResourceAsStream(resource);<br>                            mapperParser = <span class="hljs-keyword">new</span> XMLMapperBuilder(inputStream, <span class="hljs-keyword">this</span>.configuration, resource, <span class="hljs-keyword">this</span>.configuration.getSqlFragments());<br>                            mapperParser.parse();<br>                        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (resource == <span class="hljs-keyword">null</span> &amp;&amp; url != <span class="hljs-keyword">null</span> &amp;&amp; mapperClass == <span class="hljs-keyword">null</span>) &#123;<br>                            ErrorContext.instance().resource(url);<br>                            inputStream = Resources.getUrlAsStream(url);<br>                            mapperParser = <span class="hljs-keyword">new</span> XMLMapperBuilder(inputStream, <span class="hljs-keyword">this</span>.configuration, url, <span class="hljs-keyword">this</span>.configuration.getSqlFragments());<br>                            mapperParser.parse();<br>                        &#125; <span class="hljs-keyword">else</span> &#123;<br>                            <span class="hljs-keyword">if</span> (resource != <span class="hljs-keyword">null</span> || url != <span class="hljs-keyword">null</span> || mapperClass == <span class="hljs-keyword">null</span>) &#123;<br>                                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BuilderException(<span class="hljs-string">&quot;A mapper element may only specify a url, resource or class, but not more than one.&quot;</span>);<br>                            &#125;<br><br>                            Class&lt;?&gt; mapperInterface = Resources.classForName(mapperClass);<br>                            <span class="hljs-keyword">this</span>.configuration.addMapper(mapperInterface);<br>                        &#125;<br>                    &#125;<br>                &#125;<br>                <span class="hljs-keyword">return</span>;<br>            &#125;<br>        &#125;<br>    &#125;<br></code></pre></div></td></tr></table></figure>
<ol>
<li><p>这个方法一开始是一个循环，为什么要循环呢？因为一个mappers节点下面可能会有很多mapper节点。在应用中肯定不止一个mapper.xml。所以会去遍历每一个mapper节点去解析该节点所映射的xml文件。</p>
</li>
<li><p>循环下面是一个if..else判断。它先判断mappers下面的子节点是不是package节点。因为在实际开发中有很多的xml文件，不可能每一个xml文件都用一个mapper节点去映射，我们干脆会用一个package节点去映射一个包下面的所有的xml，这是<strong>多文件映射</strong>。</p>
</li>
<li><p>如果不是package节点那肯定就是mapper节点做单文件映射。看下面的三行代码，发现单文件映射有3种方式。</p>
<ol>
<li><p>使用mapper节点的resource属性直接映射xml文件。<code>&lt;mapper resource=&quot;UserMapper.xml&quot;/&gt;</code></p>
</li>
<li><p>使用mapper节点url属性映射磁盘内的某个xml文件。</p>
<p> <code>&lt;mapper url=&quot;D:\coder_soft\idea_workspace\ecard_bus\spring-boot-analyze\target\classes\UserMapper.xml&quot;/&gt;</code></p>
</li>
<li><p>使用mapper节点的class属性直接映射某个mapper接口。可以回头看看我的主配置文件的mappers节点。</p>
<p> <code>&lt;mapper class=&quot;com.wsdsg.spring.boot.analyze.mapper.UserMapper&quot;/&gt;</code></p>
</li>
</ol>
</li>
</ol>
<blockquote>
<p>总结：解析主配置文件把主配置文件里的所有信息封装到 <code>Configuration</code> 这个对象中。</p>
</blockquote>
<h3 id="1-3-以resource方式解析"><a href="#1-3-以resource方式解析" class="headerlink" title="1.3 以resource方式解析"></a>1.3 以resource方式解析</h3><p>实际上映射xml的方式看源码可以得出有4种方式，先看单文件映射的resource方式。</p>
<figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">if</span> (resource != <span class="hljs-keyword">null</span> &amp;&amp; url == <span class="hljs-keyword">null</span> &amp;&amp; mapperClass == <span class="hljs-keyword">null</span>) &#123;<br>        ErrorContext.instance().resource(resource);<br>        inputStream = Resources.getResourceAsStream(resource);<br>        mapperParser = <span class="hljs-keyword">new</span> XMLMapperBuilder(inputStream, <span class="hljs-keyword">this</span>.configuration, resource, <span class="hljs-keyword">this</span>.configuration.getSqlFragments());<br>	  <span class="hljs-comment">// 方法执行单个 resource 文件解析</span><br>  	 mapperParser.parse();  &lt;========== <span class="hljs-number">1.3</span><span class="hljs-number">.1</span><br>&#125;<br></code></pre></div></td></tr></table></figure>
<ol>
<li>第一行代码的意思是实例化一个错误上下文对象。这个对象是干什么用的呢？使用mybatis的过程中如果出现错误会不会提示这个错误在哪个xml中，还提示这个错误在xml中的哪个sql中。这个对象的作用就是把错误信息封装起来，如果出现错误就会调用这个对象的toString方法。这个resource参数就是String类型的xml的名字，在这次的项目中是<code>UserMapper.xml</code>。</li>
<li>第二行读取这个xml获取输入流对象。</li>
<li>然后创建一个mapper的xml文件解析器，类似XMLConfigBuilder，解析Mapper.xml文件。</li>
</ol>
<h4 id="1-3-1-mapperParser-parse"><a href="#1-3-1-mapperParser-parse" class="headerlink" title="1.3.1 mapperParser.parse()"></a>1.3.1 <code>mapperParser.parse()</code></h4><p><code>mapperParser.parse()</code> 方法执行单个 resource 文件解析。</p>
<figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">parse</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.configuration.isResourceLoaded(<span class="hljs-keyword">this</span>.resource)) &#123;<br>        <span class="hljs-comment">// 将单个 mapper.xml 文件中的多个sql语句转换成多个 MappedStatement 对象</span><br>        <span class="hljs-keyword">this</span>.configurationElement(<span class="hljs-keyword">this</span>.parser.evalNode(<span class="hljs-string">&quot;/mapper&quot;</span>));   &lt;========== <span class="hljs-number">1.3</span><span class="hljs-number">.2</span><br>        <span class="hljs-comment">// 将解析了的 &lt;mapper&gt; 进行缓存快照</span><br>        <span class="hljs-keyword">this</span>.configuration.addLoadedResource(<span class="hljs-keyword">this</span>.resource);   &lt;========== <span class="hljs-number">1.3</span><span class="hljs-number">.6</span><br>        <span class="hljs-comment">// 将单个 mapper.xml 文件的解析结果进行缓存</span><br>        <span class="hljs-keyword">this</span>.bindMapperForNamespace();  &lt;========== <span class="hljs-number">1.3</span><span class="hljs-number">.7</span><br>    &#125;<br>  <br>    <span class="hljs-keyword">this</span>.parsePendingResultMaps();<br>    <span class="hljs-keyword">this</span>.parsePendingCacheRefs();<br>    <span class="hljs-keyword">this</span>.parsePendingStatements();<br>&#125;<br></code></pre></div></td></tr></table></figure>
<h4 id="1-3-2-configurationElement"><a href="#1-3-2-configurationElement" class="headerlink" title="1.3.2 configurationElement()"></a>1.3.2 <code>configurationElement()</code></h4><p><code>configurationElement()</code> 方法将单个 <code>mapper.xml</code> 文件中的多个sql语句转换成多个 <code>MappedStatement</code> 对象</p>
<p>一开始就判断这个 <code>xml</code> 是否被解析过了。因为 configuration 对象会维护一个String类型的set集合loadedResources，这个集合中存放了所有已经被解析过的xml的名字。</p>
<p><code>this.configurationElement()</code></p>
<figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configurationElement</span><span class="hljs-params">(XNode context)</span> </span>&#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        String namespace = context.getStringAttribute(<span class="hljs-string">&quot;namespace&quot;</span>);<br>        <span class="hljs-keyword">if</span> (namespace != <span class="hljs-keyword">null</span> &amp;&amp; !namespace.isEmpty()) &#123;<br>            <span class="hljs-keyword">this</span>.builderAssistant.setCurrentNamespace(namespace);<br>            <span class="hljs-keyword">this</span>.cacheRefElement(context.evalNode(<span class="hljs-string">&quot;cache-ref&quot;</span>));<br>            <span class="hljs-keyword">this</span>.cacheElement(context.evalNode(<span class="hljs-string">&quot;cache&quot;</span>));<br>            <span class="hljs-keyword">this</span>.parameterMapElement(context.evalNodes(<span class="hljs-string">&quot;/mapper/parameterMap&quot;</span>));<br>            <span class="hljs-keyword">this</span>.resultMapElements(context.evalNodes(<span class="hljs-string">&quot;/mapper/resultMap&quot;</span>));<br>            <span class="hljs-keyword">this</span>.sqlElement(context.evalNodes(<span class="hljs-string">&quot;/mapper/sql&quot;</span>));<br>            <span class="hljs-comment">// 一个一个地解析 mapper.xml 所有节点数据</span><br>            <span class="hljs-keyword">this</span>.buildStatementFromContext(context.evalNodes(<span class="hljs-string">&quot;select|insert|update|delete&quot;</span>));  &lt;========== <span class="hljs-number">1.3</span><span class="hljs-number">.3</span><br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BuilderException(<span class="hljs-string">&quot;Mapper&#x27;s namespace cannot be empty&quot;</span>);<br>        &#125;<br>    &#125; <span class="hljs-keyword">catch</span> (Exception var3) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BuilderException(<span class="hljs-string">&quot;Error parsing Mapper XML. The XML location is &#x27;&quot;</span> + <span class="hljs-keyword">this</span>.resource + <span class="hljs-string">&quot;&#x27;. Cause: &quot;</span> + var3, var3);<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>
<h4 id="1-3-3-buildStatementFromContext"><a href="#1-3-3-buildStatementFromContext" class="headerlink" title="1.3.3 buildStatementFromContext()"></a>1.3.3 <code>buildStatementFromContext()</code></h4><p>这个方法就是一个一个地解析 <code>mapper.xml</code> 所有节点数据。比如解析namespace,resultMap等等。重点是最后一句 <code>this.buildStatementFromContext(context.evalNodes(&quot;select|insert|update|delete&quot;));</code> 。</p>
<figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">buildStatementFromContext</span><span class="hljs-params">(List&lt;XNode&gt; list)</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.configuration.getDatabaseId() != <span class="hljs-keyword">null</span>) &#123;<br>        <span class="hljs-keyword">this</span>.buildStatementFromContext(list, <span class="hljs-keyword">this</span>.configuration.getDatabaseId());<br>    &#125;<br><br>    <span class="hljs-keyword">this</span>.buildStatementFromContext(list, (String)<span class="hljs-keyword">null</span>);<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>没什么好说的，继续进入 <code>this.buildStatementFromContext</code>，注意，<strong>这里的方法名和上面的方法名是一样的</strong>，都是 <code>buildStatementFromContext</code>，这里是体现了Java中的多态。</p>
<figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">buildStatementFromContext</span><span class="hljs-params">(List&lt;XNode&gt; list, String requiredDatabaseId)</span> </span>&#123;<br>    Iterator var3 = list.iterator();<br><br>    <span class="hljs-keyword">while</span>(var3.hasNext()) &#123;<br>        XNode context = (XNode)var3.next();<br>        XMLStatementBuilder statementParser = <span class="hljs-keyword">new</span> XMLStatementBuilder(<span class="hljs-keyword">this</span>.configuration, <span class="hljs-keyword">this</span>.builderAssistant, context, requiredDatabaseId);<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">// xml的会话解析器 负责解析每个sql语句（select、insert、update、delete）</span><br>            statementParser.parseStatementNode();  &lt;========== <span class="hljs-number">1.3</span><span class="hljs-number">.4</span> <br>        &#125; <span class="hljs-keyword">catch</span> (IncompleteElementException var7) &#123;<br>            <span class="hljs-keyword">this</span>.configuration.addIncompleteStatement(statementParser);<br>        &#125;<br>    &#125;<br><br>&#125;<br></code></pre></div></td></tr></table></figure>
<ol>
<li>这个方法一开始是一个循环，遍历一个list，这个list里装的是xml中的所有sql节点，比如 <code>select</code>、<code>insert</code>、<code>update</code>、<code>delete</code> ，每一个sql是一个节点。循环解析每一个sql节点。</li>
<li>创建一个<strong>xml的会话解析器</strong>去解析每个节点。</li>
</ol>
<h4 id="1-3-4-parseStatementNode"><a href="#1-3-4-parseStatementNode" class="headerlink" title="1.3.4 parseStatementNode()"></a>1.3.4 <code>parseStatementNode()</code></h4><p>进入 <code>XMLStatementBuilder.parseStatementNode()</code>，xml的会话解析器，负责解析每个sql语句（select、insert、update、delete）。</p>
<figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">parseStatementNode</span><span class="hljs-params">()</span> </span>&#123;<br>        String id = <span class="hljs-keyword">this</span>.context.getStringAttribute(<span class="hljs-string">&quot;id&quot;</span>);<br>        String databaseId = <span class="hljs-keyword">this</span>.context.getStringAttribute(<span class="hljs-string">&quot;databaseId&quot;</span>);<br>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.databaseIdMatchesCurrent(id, databaseId, <span class="hljs-keyword">this</span>.requiredDatabaseId)) &#123;<br>            String nodeName = <span class="hljs-keyword">this</span>.context.getNode().getNodeName();<br>            SqlCommandType sqlCommandType = SqlCommandType.valueOf(nodeName.toUpperCase(Locale.ENGLISH));<br>            <span class="hljs-keyword">boolean</span> isSelect = sqlCommandType == SqlCommandType.SELECT;<br>            <span class="hljs-keyword">boolean</span> flushCache = <span class="hljs-keyword">this</span>.context.getBooleanAttribute(<span class="hljs-string">&quot;flushCache&quot;</span>, !isSelect);<br>            <span class="hljs-keyword">boolean</span> useCache = <span class="hljs-keyword">this</span>.context.getBooleanAttribute(<span class="hljs-string">&quot;useCache&quot;</span>, isSelect);<br>            <span class="hljs-keyword">boolean</span> resultOrdered = <span class="hljs-keyword">this</span>.context.getBooleanAttribute(<span class="hljs-string">&quot;resultOrdered&quot;</span>, <span class="hljs-keyword">false</span>);<br>            XMLIncludeTransformer includeParser = <span class="hljs-keyword">new</span> XMLIncludeTransformer(<span class="hljs-keyword">this</span>.configuration, <span class="hljs-keyword">this</span>.builderAssistant);<br>            includeParser.applyIncludes(<span class="hljs-keyword">this</span>.context.getNode());<br>            String parameterType = <span class="hljs-keyword">this</span>.context.getStringAttribute(<span class="hljs-string">&quot;parameterType&quot;</span>);<br>            Class&lt;?&gt; parameterTypeClass = <span class="hljs-keyword">this</span>.resolveClass(parameterType);<br>            String lang = <span class="hljs-keyword">this</span>.context.getStringAttribute(<span class="hljs-string">&quot;lang&quot;</span>);<br>            LanguageDriver langDriver = <span class="hljs-keyword">this</span>.getLanguageDriver(lang);<br>            <span class="hljs-keyword">this</span>.processSelectKeyNodes(id, parameterTypeClass, langDriver);<br>            String keyStatementId = id + <span class="hljs-string">&quot;!selectKey&quot;</span>;<br>            keyStatementId = <span class="hljs-keyword">this</span>.builderAssistant.applyCurrentNamespace(keyStatementId, <span class="hljs-keyword">true</span>);<br>            Object keyGenerator;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.configuration.hasKeyGenerator(keyStatementId)) &#123;<br>                keyGenerator = <span class="hljs-keyword">this</span>.configuration.getKeyGenerator(keyStatementId);<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                keyGenerator = <span class="hljs-keyword">this</span>.context.getBooleanAttribute(<span class="hljs-string">&quot;useGeneratedKeys&quot;</span>, <span class="hljs-keyword">this</span>.configuration.isUseGeneratedKeys() &amp;&amp; SqlCommandType.INSERT.equals(sqlCommandType)) ? Jdbc3KeyGenerator.INSTANCE : NoKeyGenerator.INSTANCE;<br>            &#125;<br><br>            SqlSource sqlSource = langDriver.createSqlSource(<span class="hljs-keyword">this</span>.configuration, <span class="hljs-keyword">this</span>.context, parameterTypeClass);<br>            StatementType statementType = StatementType.valueOf(<span class="hljs-keyword">this</span>.context.getStringAttribute(<span class="hljs-string">&quot;statementType&quot;</span>, StatementType.PREPARED.toString()));<br>            Integer fetchSize = <span class="hljs-keyword">this</span>.context.getIntAttribute(<span class="hljs-string">&quot;fetchSize&quot;</span>);<br>            Integer timeout = <span class="hljs-keyword">this</span>.context.getIntAttribute(<span class="hljs-string">&quot;timeout&quot;</span>);<br>            String parameterMap = <span class="hljs-keyword">this</span>.context.getStringAttribute(<span class="hljs-string">&quot;parameterMap&quot;</span>);<br>            String resultType = <span class="hljs-keyword">this</span>.context.getStringAttribute(<span class="hljs-string">&quot;resultType&quot;</span>);<br>            Class&lt;?&gt; resultTypeClass = <span class="hljs-keyword">this</span>.resolveClass(resultType);<br>            String resultMap = <span class="hljs-keyword">this</span>.context.getStringAttribute(<span class="hljs-string">&quot;resultMap&quot;</span>);<br>            String resultSetType = <span class="hljs-keyword">this</span>.context.getStringAttribute(<span class="hljs-string">&quot;resultSetType&quot;</span>);<br>            ResultSetType resultSetTypeEnum = <span class="hljs-keyword">this</span>.resolveResultSetType(resultSetType);<br>            <span class="hljs-keyword">if</span> (resultSetTypeEnum == <span class="hljs-keyword">null</span>) &#123;<br>                resultSetTypeEnum = <span class="hljs-keyword">this</span>.configuration.getDefaultResultSetType();<br>            &#125;<br><br>            String keyProperty = <span class="hljs-keyword">this</span>.context.getStringAttribute(<span class="hljs-string">&quot;keyProperty&quot;</span>);<br>            String keyColumn = <span class="hljs-keyword">this</span>.context.getStringAttribute(<span class="hljs-string">&quot;keyColumn&quot;</span>);<br>            String resultSets = <span class="hljs-keyword">this</span>.context.getStringAttribute(<span class="hljs-string">&quot;resultSets&quot;</span>);<br>            <span class="hljs-comment">// 将 ` MappedStatement` 对象逐一缓存</span><br>            <span class="hljs-keyword">this</span>.builderAssistant.addMappedStatement(id, sqlSource, statementType, sqlCommandType, fetchSize, timeout, parameterMap, parameterTypeClass, resultMap, resultTypeClass, resultSetTypeEnum, flushCache, useCache, resultOrdered, (KeyGenerator)keyGenerator, keyProperty, keyColumn, databaseId, langDriver, resultSets    &lt;========== <span class="hljs-number">1.3</span><span class="hljs-number">.5</span><br>        &#125;<br>    &#125;<br></code></pre></div></td></tr></table></figure>
<p>这个方法很长，大致意思就是<strong>解析这个sql标签里的所有数据，并把所有数据通过 <code>addMappedStatement</code> 这个方法封装在MappedStatement这个对象中</strong>。MappedStatement维护一条 <code>&lt;select|update|delete|insert&gt;</code> 节点的封装，比如这个sql标签的id ，sql语句，入参，出参，等等。<strong>牢记一个sql的标签对应一个MappedStatement对象。</strong></p>
<h4 id="1-3-5-addMapperStatement"><a href="#1-3-5-addMapperStatement" class="headerlink" title="1.3.5  addMapperStatement()"></a>1.3.5  <code>addMapperStatement()</code></h4><p> <code>addMapperStatement()</code> 方法将 <code>MappedStatement</code> 对象逐一缓存。</p>
<figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> MappedStatement <span class="hljs-title">addMappedStatement</span><span class="hljs-params">(</span></span><br><span class="hljs-function"><span class="hljs-params">    String id, </span></span><br><span class="hljs-function"><span class="hljs-params">    SqlSource sqlSource, </span></span><br><span class="hljs-function"><span class="hljs-params">    StatementType statementType, </span></span><br><span class="hljs-function"><span class="hljs-params">    SqlCommandType sqlCommandType, </span></span><br><span class="hljs-function"><span class="hljs-params">    Integer fetchSize, </span></span><br><span class="hljs-function"><span class="hljs-params">    Integer timeout, </span></span><br><span class="hljs-function"><span class="hljs-params">    String parameterMap, Class&lt;?&gt; parameterType, </span></span><br><span class="hljs-function"><span class="hljs-params">    String resultMap, Class&lt;?&gt; resultType, </span></span><br><span class="hljs-function"><span class="hljs-params">    ResultSetType resultSetType, </span></span><br><span class="hljs-function"><span class="hljs-params">    <span class="hljs-keyword">boolean</span> flushCache, </span></span><br><span class="hljs-function"><span class="hljs-params">    <span class="hljs-keyword">boolean</span> useCache, </span></span><br><span class="hljs-function"><span class="hljs-params">    <span class="hljs-keyword">boolean</span> resultOrdered, </span></span><br><span class="hljs-function"><span class="hljs-params">    KeyGenerator keyGenerator, </span></span><br><span class="hljs-function"><span class="hljs-params">    String keyProperty, </span></span><br><span class="hljs-function"><span class="hljs-params">    String keyColumn, </span></span><br><span class="hljs-function"><span class="hljs-params">    String databaseId, </span></span><br><span class="hljs-function"><span class="hljs-params">    LanguageDriver lang, </span></span><br><span class="hljs-function"><span class="hljs-params">    String resultSets)</span> </span>&#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.unresolvedCacheRef) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IncompleteElementException(<span class="hljs-string">&quot;Cache-ref not yet resolved&quot;</span>);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            id = <span class="hljs-keyword">this</span>.applyCurrentNamespace(id, <span class="hljs-keyword">false</span>);<br>            <span class="hljs-keyword">boolean</span> isSelect = sqlCommandType == SqlCommandType.SELECT;   <br>            org.apache.ibatis.mapping.MappedStatement.Builder statementBuilder = (<span class="hljs-keyword">new</span> org.apache.ibatis.mapping.MappedStatement.Builder(<span class="hljs-keyword">this</span>.configuration, id, sqlSource, sqlCommandType))<br>            .resource(<span class="hljs-keyword">this</span>.resource).<br>            fetchSize(fetchSize).<br>            timeout(timeout).<br>            statementType(statementType)<br>            .keyGenerator(keyGenerator)<br>            .keyProperty(keyProperty)<br>            .keyColumn(keyColumn)<br>            .databaseId(databaseId)<br>            .lang(lang)<br>            .resultOrdered(resultOrdered)<br>            .resultSets(resultSets)<br>            .resultMaps(<span class="hljs-keyword">this</span>.getStatementResultMaps(resultMap, resultType, id))<br>            .resultSetType(resultSetType)<br>            .flushCacheRequired((Boolean)<span class="hljs-keyword">this</span>.valueOrDefault(flushCache, !isSelect))<br>            .useCache((Boolean)<span class="hljs-keyword">this</span>.valueOrDefault(useCache, isSelect))<br>            .cache(<span class="hljs-keyword">this</span>.currentCache);<br>            ParameterMap statementParameterMap = <span class="hljs-keyword">this</span>.getStatementParameterMap(parameterMap, parameterType, id);<br>            <span class="hljs-keyword">if</span> (statementParameterMap != <span class="hljs-keyword">null</span>) &#123;<br>                statementBuilder.parameterMap(statementParameterMap);<br>            &#125;<br><br>            MappedStatement statement = statementBuilder.build();   &lt;===========<br>            <span class="hljs-keyword">this</span>.configuration.addMappedStatement(statement);<br>            <span class="hljs-keyword">return</span> statement;<br>        &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p><code>MappedStatement statement = statementBuilder.build();</code> 通过解析出的参数<strong>构建了一个MapperStatement对象</strong>。</p>
<p><code>this.configuration.addMappedStatement(statement);</code> 把解析出来的 <code>MapperStatement</code> 装到Configuration维护的Map集合中。<strong>key值是这个sql标签的id值，我们这里应该就是<code>selectUserById</code>，value值就是我们解析出来的<code>MapperStatement</code>对象。</strong></p>
<blockquote>
<p>本质：其实Mybatis解析xml的目的就是把每个xml中的每个增删改查的sql标签解析成一个个MapperStatement，<strong>并把解析出来的这些对象装到Configuration的Map中备用</strong>。这里Configuration的Map就是一个catch。</p>
</blockquote>
<h4 id="1-3-6-addLoadedResource"><a href="#1-3-6-addLoadedResource" class="headerlink" title="1.3.6 addLoadedResource()"></a>1.3.6 <code>addLoadedResource()</code></h4><p>得到所有 Sql 语句的 <code>MapperStatement</code> 对象之后，回到 <code>mapperParser.parse()</code>（<em>1.3.1 <code>mapperParser.parse()</code></em>） 。</p>
<p><code>this.configuration.addLoadedResource(this.resource);</code> 这一行是将解析了的 <code>&lt;mapper&gt;</code> 进行缓存快照，防止重复处理。</p>
<figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">parse</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.configuration.isResourceLoaded(<span class="hljs-keyword">this</span>.resource)) &#123;<br>        <span class="hljs-comment">// 将单个 mapper.xml 文件中的多个sql语句转换成多个 MappedStatement 对象</span><br>        <span class="hljs-keyword">this</span>.configurationElement(<span class="hljs-keyword">this</span>.parser.evalNode(<span class="hljs-string">&quot;/mapper&quot;</span>));   &lt;========== <span class="hljs-number">1.3</span><span class="hljs-number">.2</span><br>        <span class="hljs-comment">// 将解析了的 &lt;mapper&gt; 进行缓存快照</span><br>        <span class="hljs-keyword">this</span>.configuration.addLoadedResource(<span class="hljs-keyword">this</span>.resource);   &lt;========== <span class="hljs-number">1.3</span><span class="hljs-number">.6</span><br>        <span class="hljs-comment">// 将单个 mapper.xml 文件的解析结果进行缓存</span><br>        <span class="hljs-keyword">this</span>.bindMapperForNamespace();  &lt;========== <span class="hljs-number">1.3</span><span class="hljs-number">.7</span><br>    &#125;<br>  <br>    <span class="hljs-keyword">this</span>.parsePendingResultMaps();<br>    <span class="hljs-keyword">this</span>.parsePendingCacheRefs();<br>    <span class="hljs-keyword">this</span>.parsePendingStatements();<br>&#125;<br></code></pre></div></td></tr></table></figure>
<h4 id="1-3-7-bindMapperForNamespace"><a href="#1-3-7-bindMapperForNamespace" class="headerlink" title="1.3.7 bindMapperForNamespace()"></a>1.3.7 <code>bindMapperForNamespace()</code></h4><p>将单个 mapper.xml 文件的解析结果进行缓存。</p>
<p><code>mapperParser.parse()</code> 第三行 <code>bindMapperForNamespace()</code></p>
<figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">bindMapperForNamespace</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-comment">// value 通过动态代理生产的class对象的代理对象。</span><br>    String namespace = <span class="hljs-keyword">this</span>.builderAssistant.getCurrentNamespace();<br>    <span class="hljs-keyword">if</span> (namespace != <span class="hljs-keyword">null</span>) &#123;<br>        Class boundType = <span class="hljs-keyword">null</span>;<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">// 通过反射生产的mapper的class对象。</span><br>            boundType = Resources.classForName(namespace);<br>        &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException var4) &#123;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (boundType != <span class="hljs-keyword">null</span> &amp;&amp; !<span class="hljs-keyword">this</span>.configuration.hasMapper(boundType)) &#123;<br>            <span class="hljs-comment">// 保存value </span><br>            <span class="hljs-keyword">this</span>.configuration.addLoadedResource(<span class="hljs-string">&quot;namespace:&quot;</span> + namespace);<br>            <span class="hljs-comment">// 保存key</span><br>            <span class="hljs-keyword">this</span>.configuration.addMapper(boundType); &lt;========== <span class="hljs-number">1.3</span><span class="hljs-number">.8</span><br>        &#125;<br>    &#125;<br><br>&#125;<br></code></pre></div></td></tr></table></figure>
<ol>
<li><p>一开始获取名称空间，名称空间一般是我们mapper.xml 的全限定名（一个类的全限定名是将类全名的.全部替换为/，例如com/enjoy/learn/core/oop/method/TestClass），<strong>它通过反射获取这个mapper的class对象。</strong></p>
</li>
<li><p>if判断，Configuration中也维护了一个Map对象</p>
<ul>
<li>key：通过<strong>反射生产的mapper的class对象</strong>。</li>
<li>value：通过<strong>动态代理生产的class对象的代理对象</strong>。</li>
</ul>
</li>
<li><p>因为Map中还没有装我们生产的mapper对象，进入if中，</p>
<p> <code>configuration.addLoadedResource</code>：它先把名称空间存到我们刚才存<strong>xml名字的set集合</strong>（<code>configuration</code>对象的<code>loadedResources</code>属性）中。</p>
<p> <code>configuration.addMapper</code>：然后再把<strong>反射生产的mapper的class对象</strong>存到<strong>Mapper</strong>（<code>configuration</code>对象的<code>mapperRegistry</code>属性）中。</p>
</li>
</ol>
<h4 id="1-3-8-addMapper"><a href="#1-3-8-addMapper" class="headerlink" title="1.3.8 addMapper()"></a>1.3.8 <code>addMapper()</code></h4><figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">public</span> &lt;T&gt; <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">addMapper</span><span class="hljs-params">(Class&lt;T&gt; type)</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (type.isInterface()) &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.hasMapper(type)) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BindingException(<span class="hljs-string">&quot;Type &quot;</span> + type + <span class="hljs-string">&quot; is already known to the MapperRegistry.&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-keyword">boolean</span> loadCompleted = <span class="hljs-keyword">false</span>;<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">this</span>.knownMappers.put(type, <span class="hljs-keyword">new</span> MapperProxyFactory(type));<br>            MapperAnnotationBuilder parser = <span class="hljs-keyword">new</span> MapperAnnotationBuilder(<span class="hljs-keyword">this</span>.config, type);<br>            parser.parse();<br>            loadCompleted = <span class="hljs-keyword">true</span>;<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            <span class="hljs-keyword">if</span> (!loadCompleted) &#123;<br>                <span class="hljs-keyword">this</span>.knownMappers.remove(type);<br>            &#125;<br><br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>可以看出 <code>mapperRegistry</code> 这个类维护的Map的名字是 <code>knownMappers</code>，就是注册过的mapper。我们看他的put，key是我们生成的mapper的class对象，value是通过动态代理生成的mapper的代理对象。</p>
<blockquote>
<p>到此mybatis根据主配置文件初始化就完成了，那说了这么久到底做了什么呢？我们总结一下。通过<code>XmlConfigBuilder</code> 解析主配置文件，然后通过 <code>XmlMapperBuild</code> 解析mappers下映射的所有xml文件（循环解析）。把每个xml中的各个sql解析成一个个 <code>MapperStatement</code> 对象装在 <code>Configuration</code> 维护的一个Map集合中，key值是id，value是<code>mapperstatement</code>对象——-然后把解析过的xml的名字和名称空间装在set集合中，通过<strong>名称空间反射</strong>生成的<strong>mapper的class对象以及class对象的代理对象</strong>装在 <code>Configuration</code> 对象维护的 <code>mapperRegistry</code> 中的Map中。</p>
</blockquote>
<h3 id="1-4-以URL方式解析"><a href="#1-4-以URL方式解析" class="headerlink" title="1.4 以URL方式解析"></a>1.4 以URL方式解析</h3><p>我们用resource引入xml的方法是先解析xml ，把各个sql标签解析成mapperstatement对象装进集合，然后再把mapper接口的class对象以及代理对象装进集合，但是引入xml的方式有4种，其中单文件引入方式还有url方式和class方式，看源码可以知道url方式和resource方法一样，都是直接引入一个 <code>mapper.xml</code> ，在其基础上处理，<strong>没有区别</strong>。</p>
<figure class="highlight xml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">configuration</span></span><br><span class="hljs-meta">        <span class="hljs-meta-keyword">PUBLIC</span> <span class="hljs-meta-string">&quot;-//mybatis.org//DTD Config 3.0//EN&quot;</span></span><br><span class="hljs-meta">        <span class="hljs-meta-string">&quot;http://mybatis.org/dtd/mybatis-3-config.dtd&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span><br>  	<span class="hljs-comment">&lt;!-- </span><br><span class="hljs-comment">        properties/environments 配置 </span><br><span class="hljs-comment">        ...</span><br><span class="hljs-comment">	--&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">mappers</span>&gt;</span><br>        <span class="hljs-comment">&lt;!--resource--&gt;</span><br>         <span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">resource</span>=<span class="hljs-string">&quot;UserMapper.xml&quot;</span>/&gt;</span><br><br>        <span class="hljs-comment">&lt;!--url--&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">url</span>=<span class="hljs-string">&quot;D:\coder_soft\idea_workspace\ecard_bus\spring-boot-analyze\target\classes\UserMapper.xml&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">mappers</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span><br></code></pre></div></td></tr></table></figure>
<p><code>this.mapperElement</code> 源码中，处理 <code>url</code> 和 <code>resource</code> 的代码一摸一样：</p>
<figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">if</span> (resource != <span class="hljs-keyword">null</span> &amp;&amp; url == <span class="hljs-keyword">null</span> &amp;&amp; mapperClass == <span class="hljs-keyword">null</span>) &#123;<br>        ErrorContext.instance().resource(resource);<br>        inputStream = Resources.getResourceAsStream(resource);<br>        mapperParser = <span class="hljs-keyword">new</span> XMLMapperBuilder(inputStream, <span class="hljs-keyword">this</span>.configuration, resource, <span class="hljs-keyword">this</span>.configuration.getSqlFragments());<br>        mapperParser.parse();<br>&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (resource == <span class="hljs-keyword">null</span> &amp;&amp; url != <span class="hljs-keyword">null</span> &amp;&amp; mapperClass == <span class="hljs-keyword">null</span>) &#123;<br>        ErrorContext.instance().resource(url);<br>        inputStream = Resources.getUrlAsStream(url);<br>        mapperParser = <span class="hljs-keyword">new</span> XMLMapperBuilder(inputStream, <span class="hljs-keyword">this</span>.configuration, url, <span class="hljs-keyword">this</span>.configuration.getSqlFragments());<br>        mapperParser.parse();<br>&#125; <br></code></pre></div></td></tr></table></figure>
<h3 id="1-5-以Class方式解析"><a href="#1-5-以Class方式解析" class="headerlink" title="1.5 以Class方式解析"></a>1.5 以Class方式解析</h3><p>class方式是引入一个mapper接口，同resource和url的处理方法相反。</p>
<figure class="highlight xml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">configuration</span></span><br><span class="hljs-meta">        <span class="hljs-meta-keyword">PUBLIC</span> <span class="hljs-meta-string">&quot;-//mybatis.org//DTD Config 3.0//EN&quot;</span></span><br><span class="hljs-meta">        <span class="hljs-meta-string">&quot;http://mybatis.org/dtd/mybatis-3-config.dtd&quot;</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span><br>  	<span class="hljs-comment">&lt;!-- </span><br><span class="hljs-comment">        properties/environments 配置 </span><br><span class="hljs-comment">        ...</span><br><span class="hljs-comment">	--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">mappers</span>&gt;</span><br>    		<span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.wsdsg.spring.boot.analyze.mapper.UserMapper&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">mappers</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span><br><br></code></pre></div></td></tr></table></figure>
<p><code>this.mapperElement</code> 源码中，处理 <code>class</code> 文件解析的代码如下，先反射生产mapper接口的class对象，再调用Configuration的addMpper方法。</p>
<figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">else</span> &#123;<br>          <span class="hljs-keyword">if</span> (resource != <span class="hljs-keyword">null</span> || url != <span class="hljs-keyword">null</span> || mapperClass == <span class="hljs-keyword">null</span>) &#123;<br>          		<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BuilderException(<span class="hljs-string">&quot;A mapper element may only specify a url, resource or class, but not more than one.&quot;</span>);<br>          &#125;<br>          <span class="hljs-comment">// 反射生产mapper接口的class对象</span><br>          Class&lt;?&gt; mapperInterface = Resources.classForName(mapperClass);<br>          <span class="hljs-keyword">this</span>.configuration.addMapper(mapperInterface);<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p><code>this.configuration.addMapper()</code> 方法如下，和 <em>1.3.8 <code>addMapper()</code></em> 一样。</p>
<figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">public</span> &lt;T&gt; <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">addMapper</span><span class="hljs-params">(Class&lt;T&gt; type)</span> </span>&#123;<br>    <span class="hljs-keyword">this</span>.mapperRegistry.addMapper(type);<br>&#125;<br><br><span class="hljs-keyword">public</span> &lt;T&gt; <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">addMapper</span><span class="hljs-params">(Class&lt;T&gt; type)</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (type.isInterface()) &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.hasMapper(type)) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BindingException(<span class="hljs-string">&quot;Type &quot;</span> + type + <span class="hljs-string">&quot; is already known to the MapperRegistry.&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-keyword">boolean</span> loadCompleted = <span class="hljs-keyword">false</span>;<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">this</span>.knownMappers.put(type, <span class="hljs-keyword">new</span> MapperProxyFactory(type));<br>            MapperAnnotationBuilder parser = <span class="hljs-keyword">new</span> MapperAnnotationBuilder(<span class="hljs-keyword">this</span>.config, type);<br>            parser.parse();<br>            loadCompleted = <span class="hljs-keyword">true</span>;<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            <span class="hljs-keyword">if</span> (!loadCompleted) &#123;<br>                <span class="hljs-keyword">this</span>.knownMappers.remove(type);<br>            &#125;<br><br>        &#125;<br>    &#125;<br><br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>生产mapper的class对象后，再通过动态代理生产代理对象然后装进集合。</p>
<p>那我们接口对象生成了，但是还没解析xml呢，别急我们进入parser.parse()这个方法</p>
<h4 id="1-5-1-parser-parse"><a href="#1-5-1-parser-parse" class="headerlink" title="1.5.1 parser.parse()"></a>1.5.1 <code>parser.parse()</code></h4><ul>
<li>开始会判断这个mapper对应的xml是否存在于装已经解析过的xml的set集合中。</li>
<li>如果没有缓存，进入if中 重点来了，<code>loadXmlResource()</code> 这个方法看名字就知道是加载xml资源。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">parse</span><span class="hljs-params">()</span> </span>&#123;<br>    String resource = <span class="hljs-keyword">this</span>.type.toString();<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.configuration.isResourceLoaded(resource)) &#123;<br>        <span class="hljs-keyword">this</span>.loadXmlResource();    &lt;======== <span class="hljs-number">1.5</span><span class="hljs-number">.2</span><br>        <span class="hljs-keyword">this</span>.configuration.addLoadedResource(resource);<br>        <span class="hljs-keyword">this</span>.assistant.setCurrentNamespace(<span class="hljs-keyword">this</span>.type.getName());<br>        <span class="hljs-keyword">this</span>.parseCache();<br>        <span class="hljs-keyword">this</span>.parseCacheRef();<br>        Method[] var2 = <span class="hljs-keyword">this</span>.type.getMethods();<br>        <span class="hljs-keyword">int</span> var3 = var2.length;<br><br>        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> var4 = <span class="hljs-number">0</span>; var4 &lt; var3; ++var4) &#123;<br>            Method method = var2[var4];<br>            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.canHaveStatement(method)) &#123;<br>                <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.getAnnotationWrapper(method, <span class="hljs-keyword">false</span>, Select.class, SelectProvider.class).isPresent() &amp;&amp; method.getAnnotation(ResultMap.class) == <span class="hljs-keyword">null</span>) &#123;<br>                    <span class="hljs-keyword">this</span>.parseResultMap(method);<br>                &#125;<br><br>                <span class="hljs-keyword">try</span> &#123;<br>                    <span class="hljs-keyword">this</span>.parseStatement(method);<br>                &#125; <span class="hljs-keyword">catch</span> (IncompleteElementException var7) &#123;<br>                    <span class="hljs-keyword">this</span>.configuration.addIncompleteMethod(<span class="hljs-keyword">new</span> MethodResolver(<span class="hljs-keyword">this</span>, method));<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">this</span>.parsePendingMethods();<br>&#125;<br></code></pre></div></td></tr></table></figure>
<h4 id="1-5-2-loadXmlResource"><a href="#1-5-2-loadXmlResource" class="headerlink" title="1.5.2 loadXmlResource()"></a>1.5.2 <code>loadXmlResource()</code></h4><p>根据class name拼接，xml文件名称，调用 <code>XMLMapperBuilder.parse()</code> 来解析。</p>
<figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">loadXmlResource</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.configuration.isResourceLoaded(<span class="hljs-string">&quot;namespace:&quot;</span> + <span class="hljs-keyword">this</span>.type.getName())) &#123;<br>        String xmlResource = <span class="hljs-keyword">this</span>.type.getName().replace(<span class="hljs-string">&#x27;.&#x27;</span>, <span class="hljs-string">&#x27;/&#x27;</span>) + <span class="hljs-string">&quot;.xml&quot;</span>;<br>        InputStream inputStream = <span class="hljs-keyword">this</span>.type.getResourceAsStream(<span class="hljs-string">&quot;/&quot;</span> + xmlResource);<br>        <span class="hljs-keyword">if</span> (inputStream == <span class="hljs-keyword">null</span>) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                inputStream = Resources.getResourceAsStream(<span class="hljs-keyword">this</span>.type.getClassLoader(), xmlResource);<br>            &#125; <span class="hljs-keyword">catch</span> (IOException var4) &#123;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (inputStream != <span class="hljs-keyword">null</span>) &#123;<br>            XMLMapperBuilder xmlParser = <span class="hljs-keyword">new</span> XMLMapperBuilder(inputStream, <span class="hljs-keyword">this</span>.assistant.getConfiguration(), xmlResource, <span class="hljs-keyword">this</span>.configuration.getSqlFragments(), <span class="hljs-keyword">this</span>.type.getName());<br>            xmlParser.parse();   &lt;======== <span class="hljs-number">1.5</span><span class="hljs-number">.3</span><br>        &#125;<br>    &#125;<br><br>&#125;<br></code></pre></div></td></tr></table></figure>
<h4 id="1-5-3-XMLMapperBuilder-parse"><a href="#1-5-3-XMLMapperBuilder-parse" class="headerlink" title="1.5.3 XMLMapperBuilder.parse()"></a>1.5.3 <code>XMLMapperBuilder.parse()</code></h4><p>代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">parse</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.configuration.isResourceLoaded(<span class="hljs-keyword">this</span>.resource)) &#123;<br>        <span class="hljs-keyword">this</span>.configurationElement(<span class="hljs-keyword">this</span>.parser.evalNode(<span class="hljs-string">&quot;/mapper&quot;</span>));<br>        <span class="hljs-keyword">this</span>.configuration.addLoadedResource(<span class="hljs-keyword">this</span>.resource);<br>        <span class="hljs-keyword">this</span>.bindMapperForNamespace();<br>    &#125;<br><br>    <span class="hljs-keyword">this</span>.parsePendingResultMaps();<br>    <span class="hljs-keyword">this</span>.parsePendingCacheRefs();<br>    <span class="hljs-keyword">this</span>.parsePendingStatements();<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>可以发现，1.5.3 <code>XMLMapperBuilder.parse()</code> 和 1.3.1<code>mapperParser.parse()</code> 一摸一样，也就是执行了1.3.1 到 1.3.8 的逻辑。</p>
<figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">parse</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.configuration.isResourceLoaded(<span class="hljs-keyword">this</span>.resource)) &#123;<br>        <span class="hljs-comment">// 将单个 mapper.xml 文件中的多个sql语句转换成多个 MappedStatement 对象</span><br>        <span class="hljs-keyword">this</span>.configurationElement(<span class="hljs-keyword">this</span>.parser.evalNode(<span class="hljs-string">&quot;/mapper&quot;</span>));   &lt;========== <span class="hljs-number">1.3</span><span class="hljs-number">.2</span><br>        <span class="hljs-comment">// 将解析了的 &lt;mapper&gt; 进行缓存快照</span><br>        <span class="hljs-keyword">this</span>.configuration.addLoadedResource(<span class="hljs-keyword">this</span>.resource);   &lt;========== <span class="hljs-number">1.3</span><span class="hljs-number">.6</span><br>        <span class="hljs-comment">// 将单个 mapper.xml 文件的解析结果进行缓存</span><br>        <span class="hljs-keyword">this</span>.bindMapperForNamespace();  &lt;========== <span class="hljs-number">1.3</span><span class="hljs-number">.7</span><br>    &#125;<br>  <br>    <span class="hljs-keyword">this</span>.parsePendingResultMaps();<br>    <span class="hljs-keyword">this</span>.parsePendingCacheRefs();<br>    <span class="hljs-keyword">this</span>.parsePendingStatements();<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p><strong>resource/url方法</strong></p>
<blockquote>
<p>resource和url是直接引入xml，那我们就先解析xml，然后通过xml的名称空间反射生成mapper的class对象，再通过动态代理生产class对象的代理对象。</p>
</blockquote>
<p><strong>class方法</strong></p>
<blockquote>
<p>class方式填写的是mapper接口的全限定名（一个类的全限定名是将类全名的.全部替换为/，例如com/enjoy/learn/core/oop/method/TestClass），就是上面的那个名称空间，所以先生成class对象和代理对象，然后通过拼接字符串就是全限定名+“.xml”获取xml的名称，然后再解析xml。</p>
</blockquote>
<h3 id="1-6-多文件解析"><a href="#1-6-多文件解析" class="headerlink" title="1.6 多文件解析"></a>1.6 多文件解析</h3><p><code>mapperElement()</code>方法中，关于多文件解析的入口代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;package&quot;</span>.equals(child.getName())) &#123;<br>	resource = child.getStringAttribute(<span class="hljs-string">&quot;name&quot;</span>);<br>	<span class="hljs-keyword">this</span>.configuration.addMappers(resource);   &lt;======= <span class="hljs-number">1.6</span><span class="hljs-number">.1</span><br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>它首先或得xml所在的包名，然后调用configuration的addMappers对象，是不是有点眼熟，</p>
<p>单文件映射是addMapper，</p>
<p>多文件映射是addMappers。</p>
<h4 id="1-6-1-mapperElement"><a href="#1-6-1-mapperElement" class="headerlink" title="1.6.1 mapperElement()"></a>1.6.1 <code>mapperElement()</code></h4><p>分两个文件，三个方法。</p>
<figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">addMappers</span><span class="hljs-params">(String packageName)</span> </span>&#123;<br>    <span class="hljs-keyword">this</span>.mapperRegistry.addMappers(packageName);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">addMappers</span><span class="hljs-params">(String packageName)</span> </span>&#123;<br>    <span class="hljs-keyword">this</span>.addMappers(packageName, Object.class);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">addMappers</span><span class="hljs-params">(String packageName, Class&lt;?&gt; superType)</span> </span>&#123;<br>    ResolverUtil&lt;Class&lt;?&gt;&gt; resolverUtil = <span class="hljs-keyword">new</span> ResolverUtil();<br>    resolverUtil.find(<span class="hljs-keyword">new</span> IsA(superType), packageName);<br>    Set&lt;Class&lt;? extends Class&lt;?&gt;&gt;&gt; mapperSet = resolverUtil.getClasses();<br>    Iterator var5 = mapperSet.iterator();<br><br>    <span class="hljs-keyword">while</span>(var5.hasNext()) &#123;<br>        Class&lt;?&gt; mapperClass = (Class)var5.next();<br>        <span class="hljs-keyword">this</span>.addMapper(mapperClass);<br>    &#125;<br><br>&#125;<br></code></pre></div></td></tr></table></figure>
<ul>
<li>通过 <code>ResolverUtil</code> 这个解析工具类找出该包下的所有 <code>mapper</code> 的名称。</li>
<li>通过反射生产<code>mapper</code>的class对象装进集合中。</li>
<li>循环调用 <code>addMapper(mapperClass)</code> 这个方法，这就和单文件映射的class类型一样了，把mapper接口的class对象作为参数传进去，然后生产代理对象装进集合然后再解析xml。</li>
</ul>
<blockquote>
<p> 到此mybatis的初始化就完成了。</p>
</blockquote>
<h2 id="2-获取SqlSession对象"><a href="#2-获取SqlSession对象" class="headerlink" title="2 获取SqlSession对象"></a>2 获取SqlSession对象</h2><h3 id="2-1-DefaultSqlSessionFactory-Object"><a href="#2-1-DefaultSqlSessionFactory-Object" class="headerlink" title="2.1  DefaultSqlSessionFactory Object"></a>2.1  <code>DefaultSqlSessionFactory Object</code></h3><p>获取<code>DefaultSqlSessionFactory Object</code>，根据主配置文件的流对象构建一个会话工厂对象。</p>
<figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java">SqlSessionFactory sqlSessionFactory = <span class="hljs-keyword">new</span> SqlSessionFactoryBuilder().build(inputStream); &lt;===== 第一层<br></code></pre></div></td></tr></table></figure>
<p>其实我们点进去</p>
<figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">// 第一层 </span><br><span class="hljs-function"><span class="hljs-keyword">public</span> SqlSessionFactory <span class="hljs-title">build</span><span class="hljs-params">(InputStream inputStream)</span> </span>&#123;<br>	<span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.build((InputStream)inputStream, (String)<span class="hljs-keyword">null</span>, (Properties)<span class="hljs-keyword">null</span>); &lt;===== 第二层<br>&#125;<br><br><span class="hljs-comment">// 第二层</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> SqlSessionFactory <span class="hljs-title">build</span><span class="hljs-params">(InputStream inputStream, String environment, Properties properties)</span> </span>&#123;<br>    SqlSessionFactory var5;<br>    <span class="hljs-keyword">try</span> &#123;<br>        XMLConfigBuilder parser = <span class="hljs-keyword">new</span> XMLConfigBuilder(inputStream, environment, properties);<br>        var5 = <span class="hljs-keyword">this</span>.build(parser.parse());    &lt;===== 第三层<br>    &#125; <span class="hljs-keyword">catch</span> (Exception var14) &#123;<br>        <span class="hljs-keyword">throw</span> ExceptionFactory.wrapException(<span class="hljs-string">&quot;Error building SqlSession.&quot;</span>, var14);<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>        ErrorContext.instance().reset();<br>        <span class="hljs-keyword">try</span> &#123;<br>            inputStream.close();<br>        &#125; <span class="hljs-keyword">catch</span> (IOException var13) &#123;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> var5;<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>会发现最后返回的是 <code>DefaultSqlSessionFactory</code> 对象，获得该对象。</p>
<figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">// 第三层</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> SqlSessionFactory <span class="hljs-title">build</span><span class="hljs-params">(Configuration config)</span> </span>&#123;<br>	<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> DefaultSqlSessionFactory(config);<br>&#125;<br></code></pre></div></td></tr></table></figure>
<h3 id="2-2-SqlSession-Object"><a href="#2-2-SqlSession-Object" class="headerlink" title="2.2 SqlSession Object"></a>2.2 <code>SqlSession Object</code></h3><p>获取会话对象<code>SqlSession Object</code>，走的代码如下，直接open一个session，SqlSession是与数据库互动的顶级api，所有的增删改查都要调用session。</p>
<figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java">SqlSession session = sqlSessionFactory.openSession();   &lt;===== 进入openSession<br></code></pre></div></td></tr></table></figure>
<p>进入<code>openSession()</code></p>
<figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">SqlSessionFactory</span> </span>&#123;<br><br>  <span class="hljs-function">SqlSession <span class="hljs-title">openSession</span><span class="hljs-params">()</span></span>;<br><br>  <span class="hljs-function">SqlSession <span class="hljs-title">openSession</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> autoCommit)</span></span>;<br><br>  <span class="hljs-function">SqlSession <span class="hljs-title">openSession</span><span class="hljs-params">(Connection connection)</span></span>;<br><br>  <span class="hljs-function">SqlSession <span class="hljs-title">openSession</span><span class="hljs-params">(TransactionIsolationLevel level)</span></span>;<br><br>  <span class="hljs-function">SqlSession <span class="hljs-title">openSession</span><span class="hljs-params">(ExecutorType execType)</span></span>;<br><br>  <span class="hljs-function">SqlSession <span class="hljs-title">openSession</span><span class="hljs-params">(ExecutorType execType, <span class="hljs-keyword">boolean</span> autoCommit)</span></span>;<br><br>  <span class="hljs-function">SqlSession <span class="hljs-title">openSession</span><span class="hljs-params">(ExecutorType execType, TransactionIsolationLevel level)</span></span>;<br><br>  <span class="hljs-function">SqlSession <span class="hljs-title">openSession</span><span class="hljs-params">(ExecutorType execType, Connection connection)</span></span>;<br><br>  <span class="hljs-function">Configuration <span class="hljs-title">getConfiguration</span><span class="hljs-params">()</span></span>;<br><br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>这个一个接口，它的实现类就是，2.1 获得的 <code>DefaultSqlSessionFactory</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> SqlSession <span class="hljs-title">openSession</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">return</span> openSessionFromDataSource(configuration.getDefaultExecutorType(), <span class="hljs-keyword">null</span>, <span class="hljs-keyword">false</span>);<br>  &#125;<br><br><br><span class="hljs-function"><span class="hljs-keyword">private</span> SqlSession <span class="hljs-title">openSessionFromDataSource</span><span class="hljs-params">(ExecutorType execType, TransactionIsolationLevel level, <span class="hljs-keyword">boolean</span> autoCommit)</span> </span>&#123;<br>    Transaction tx = <span class="hljs-keyword">null</span>;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-keyword">final</span> Environment environment = configuration.getEnvironment();<br>      <span class="hljs-keyword">final</span> TransactionFactory transactionFactory = getTransactionFactoryFromEnvironment(environment);<br>      tx = transactionFactory.newTransaction(environment.getDataSource(), level, autoCommit);<br>      <span class="hljs-keyword">final</span> Executor executor = configuration.newExecutor(tx, execType);<br>      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> DefaultSqlSession(configuration, executor, autoCommit);<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>      closeTransaction(tx); <span class="hljs-comment">// may have fetched a connection so lets call close()</span><br>      <span class="hljs-keyword">throw</span> ExceptionFactory.wrapException(<span class="hljs-string">&quot;Error opening session.  Cause: &quot;</span> + e, e);<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>      ErrorContext.instance().reset();<br>    &#125;<br>  &#125;<br></code></pre></div></td></tr></table></figure>
<p>我们看第二段代码：因为我们解析主配置文件把所有的节点信息都保存在了configuration对象中，它开始直接或得Environment节点的信息，这个节点配置了数据库连接和事务。之后通过Environment创建了一个事务工厂，然后通过事务工厂实例化了一个事务对象。 重点来了———&gt; 最后他创建了一个执行器Executor ，我们知道session是与数据库交互的顶层api，session中会维护一个Executor 来负责sql生产和执行和查询缓存等。我们再来看看new这个执行器的时候的过程</p>
<p>执行器生成完后返回了一个DefaultSqlSession，这里面维护了Configuration和Executor。</p>
<pre><code class=" mermaid">graph TB
	subgraph step 0 配置加载
		a[获取mybatis主配置文件的输入流对象] --&gt; b[InputStream Object]
	end
	subgraph step 1 构建会话工厂对象
		b --&gt; c[创建XMLConfigBuilder对象]
		c --&gt; d[解析主配置文件]
	end
</code></pre>
<p><code>Configuration</code> 主要属性</p>
<figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Configuration</span> </span>&#123;<br>    <span class="hljs-keyword">protected</span> Environment environment;<br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">boolean</span> safeRowBoundsEnabled;<br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">boolean</span> safeResultHandlerEnabled;<br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">boolean</span> mapUnderscoreToCamelCase;<br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">boolean</span> aggressiveLazyLoading;<br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">boolean</span> multipleResultSetsEnabled;<br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">boolean</span> useGeneratedKeys;<br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">boolean</span> useColumnLabel;<br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">boolean</span> cacheEnabled;<br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">boolean</span> callSettersOnNulls;<br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">boolean</span> useActualParamName;<br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">boolean</span> returnInstanceForEmptyRow;<br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">boolean</span> shrinkWhitespacesInSql;<br>    <span class="hljs-keyword">protected</span> String logPrefix;<br>    <span class="hljs-keyword">protected</span> Class&lt;? extends Log&gt; logImpl;<br>    <span class="hljs-keyword">protected</span> Class&lt;? extends VFS&gt; vfsImpl;<br>    <span class="hljs-keyword">protected</span> LocalCacheScope localCacheScope;<br>    <span class="hljs-keyword">protected</span> JdbcType jdbcTypeForNull;<br>    <span class="hljs-keyword">protected</span> Set&lt;String&gt; lazyLoadTriggerMethods;<br>    <span class="hljs-keyword">protected</span> Integer defaultStatementTimeout;<br>    <span class="hljs-keyword">protected</span> Integer defaultFetchSize;<br>    <span class="hljs-keyword">protected</span> ResultSetType defaultResultSetType;<br>    <span class="hljs-keyword">protected</span> ExecutorType defaultExecutorType;<br>    <span class="hljs-keyword">protected</span> AutoMappingBehavior autoMappingBehavior;<br>    <span class="hljs-keyword">protected</span> AutoMappingUnknownColumnBehavior autoMappingUnknownColumnBehavior;<br>    <span class="hljs-keyword">protected</span> Properties variables;<br>    <span class="hljs-keyword">protected</span> ReflectorFactory reflectorFactory;<br>    <span class="hljs-keyword">protected</span> ObjectFactory objectFactory;<br>    <span class="hljs-keyword">protected</span> ObjectWrapperFactory objectWrapperFactory;<br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">boolean</span> lazyLoadingEnabled;<br>    <span class="hljs-keyword">protected</span> ProxyFactory proxyFactory;<br>    <span class="hljs-keyword">protected</span> String databaseId;<br>    <span class="hljs-keyword">protected</span> Class&lt;?&gt; configurationFactory;<br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> MapperRegistry mapperRegistry;<br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> InterceptorChain interceptorChain;<br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> TypeHandlerRegistry typeHandlerRegistry;<br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> TypeAliasRegistry typeAliasRegistry;<br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> LanguageDriverRegistry languageRegistry;<br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> Map&lt;String, MappedStatement&gt; mappedStatements;<br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> Map&lt;String, Cache&gt; caches;<br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> Map&lt;String, ResultMap&gt; resultMaps;<br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> Map&lt;String, ParameterMap&gt; parameterMaps;<br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> Map&lt;String, KeyGenerator&gt; keyGenerators;<br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> Set&lt;String&gt; loadedResources;<br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> Map&lt;String, XNode&gt; sqlFragments;<br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> Collection&lt;XMLStatementBuilder&gt; incompleteStatements;<br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> Collection&lt;CacheRefResolver&gt; incompleteCacheRefs;<br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> Collection&lt;ResultMapResolver&gt; incompleteResultMaps;<br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> Collection&lt;MethodResolver&gt; incompleteMethods;<br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> Map&lt;String, String&gt; cacheRefMap;<br>&#125;<br></code></pre></div></td></tr></table></figure>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/Java%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91/">Java后端开发</a>
                    
                  </div>
                
                
              </div>
              
                <p class="note note-warning">本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！</p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2020/09/06/Mysql%E7%9A%84%E7%B4%A2%E5%BC%95%E5%B7%A5%E4%BD%9C%E6%9C%BA%E5%88%B6/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">Mysql的索引工作机制</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2020/08/23/Spring-Boot-AOP-mechanism/">
                        <span class="hidden-mobile">Spring Boot AOP mechanism</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
              <!-- Comments -->
              <article class="comments" id="comments">
                
                
  <div class="disqus" style="width:100%">
    <div id="disqus_thread"></div>
    <script type="text/javascript">
      var disqus_config = function() {
        this.page.url = 'http://example.com/2020/08/26/Mybatis%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86/';
        this.page.identifier = '/2020/08/26/Mybatis%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86/';
      };
      Fluid.utils.waitElementVisible('disqus_thread', function () {
        var d = document, s = d.createElement('script');
        s.src = '//' + 'codesisart' + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', new Date());
        (d.head || d.body).appendChild(s);
      });
    </script>
    <noscript>Please enable JavaScript to view the
      <a target="_blank" href="https://disqus.com/?ref_noscript" rel="nofollow noopener noopener">comments powered by Disqus.</a>
    </noscript>
  </div>


              </article>
            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
  </div>
  

  

  
</footer>

<!-- SCRIPTS -->

  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js" ></script>
<script  src="/js/debouncer.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  
    <script  src="/js/lazyload.js" ></script>
  



  



  <script  src="https://cdn.jsdelivr.net/npm/tocbot@4.12.0/dist/tocbot.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4.3.0/anchor.min.js" ></script>



  <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js" ></script>






  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2.0.11/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>



  <script  src="/js/local-search.js" ></script>
  <script>
    (function () {
      var path = "/local-search.xml";
      var inputArea = document.querySelector("#local-search-input");
      inputArea.onclick = function () {
        searchFunc(path, 'local-search-input', 'local-search-result');
        this.onclick = null
      }
    })()
  </script>









  <script  src="https://cdn.jsdelivr.net/npm/mermaid@8.8.3/dist/mermaid.min.js" ></script>
  <script>
    if (window.mermaid) {
      mermaid.initialize({"theme":"default"});
    }
  </script>







<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>



</body>
</html>
